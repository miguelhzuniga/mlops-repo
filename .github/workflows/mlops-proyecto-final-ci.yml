name: Construir y Subir Im√°genes MLOps

on:
  push:
    branches: [ '*' ]
    paths:
      - 'proyecto-04/01_Primera_maquina/airflow/Dockerfile'
      - 'proyecto-04/01_Primera_maquina/airflow/requirements.txt'
      - 'proyecto-04/01_Primera_maquina/airflow/dags/**'
      - 'proyecto-04/01_Primera_maquina/mlflow/Dockerfile.mlflow'
      - 'proyecto-04/01_Primera_maquina/mlflow/manifests/**'
      - 'proyecto-04/02_Segunda_maquina/api/fastapi/**'
      - 'proyecto-04/02_Segunda_maquina/api/gradio/**'
      - '.github/workflows/mlops-images.yml'
  pull_request:
    branches: [ master ]
    paths:
      - 'proyecto-04/01_Primera_maquina/airflow/Dockerfile'
      - 'proyecto-04/01_Primera_maquina/airflow/requirements.txt'
      - 'proyecto-04/01_Primera_maquina/airflow/dags/**'
      - 'proyecto-04/01_Primera_maquina/mlflow/Dockerfile.mlflow'
      - 'proyecto-04/01_Primera_maquina/mlflow/manifests/**'
      - 'proyecto-04/02_Segunda_maquina/api/fastapi/**'
      - 'proyecto-04/02_Segunda_maquina/api/gradio/**'

env:
  REGISTRY: docker.io

jobs:
  build-airflow:
    name: Construir Imagen Airflow
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.extract-tag.outputs.tag }}
    
    steps:
    - name: Descargar c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Iniciar sesi√≥n en Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Extraer metadatos de Airflow
      id: meta-airflow
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKER_USERNAME }}/airflow-houses
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=raw,value=latest,enable=${{ github.ref == 'refs/heads/master' }}
          type=sha,prefix={{date 'YYYYMMDD'}}-
          
    - name: Construir y subir imagen Airflow
      uses: docker/build-push-action@v5
      with:
        context: ./proyecto-04/01_Primera_maquina/airflow
        file: ./proyecto-04/01_Primera_maquina/airflow/Dockerfile
        push: true
        tags: ${{ steps.meta-airflow.outputs.tags }}
        labels: ${{ steps.meta-airflow.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha,scope=airflow
        cache-to: type=gha,mode=max,scope=airflow
        
    - name: Extraer tag de despliegue
      id: extract-tag
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
          echo "tag=$(date '+%Y%m%d')-${{ github.sha }}" >> $GITHUB_OUTPUT
        else
          echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        fi
        
    - name: Resumen imagen Airflow
      run: |
        echo "‚úÖ ¬°Imagen Airflow construida y subida exitosamente!"
        echo "üì¶ Imagen: ${{ secrets.DOCKER_USERNAME }}/airflow-houses"
        echo "üè∑Ô∏è  Tags: ${{ steps.meta-airflow.outputs.tags }}"
        echo "üéØ Tag de despliegue: ${{ steps.extract-tag.outputs.tag }}"

  build-mlflow:
    name: Construir Imagen MLflow
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.extract-tag.outputs.tag }}
    
    steps:
    - name: Descargar c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Iniciar sesi√≥n en Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Extraer metadatos de MLflow
      id: meta-mlflow
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKER_USERNAME }}/mlflow-houses
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=raw,value=latest,enable=${{ github.ref == 'refs/heads/master' }}
          type=sha,prefix={{date 'YYYYMMDD'}}-
          
    - name: Construir y subir imagen MLflow
      uses: docker/build-push-action@v5
      with:
        context: ./proyecto-04/01_Primera_maquina/mlflow
        file: ./proyecto-04/01_Primera_maquina/mlflow/Dockerfile.mlflow
        push: true
        tags: ${{ steps.meta-mlflow.outputs.tags }}
        labels: ${{ steps.meta-mlflow.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha,scope=mlflow
        cache-to: type=gha,mode=max,scope=mlflow
        
    - name: Extraer tag de despliegue
      id: extract-tag
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
          echo "tag=$(date '+%Y%m%d')-${{ github.sha }}" >> $GITHUB_OUTPUT
        else
          echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        fi
        
    - name: Resumen imagen MLflow
      run: |
        echo "‚úÖ ¬°Imagen MLflow construida y subida exitosamente!"
        echo "üì¶ Imagen: ${{ secrets.DOCKER_USERNAME }}/mlflow-houses"
        echo "üè∑Ô∏è  Tags: ${{ steps.meta-mlflow.outputs.tags }}"
        echo "üéØ Tag de despliegue: ${{ steps.extract-tag.outputs.tag }}"

  build-fastapi:
    name: Construir Imagen FastAPI
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.extract-tag.outputs.tag }}
    
    steps:
    - name: Descargar c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Iniciar sesi√≥n en Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Extraer metadatos de FastAPI
      id: meta-fastapi
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKER_USERNAME }}/fastapi-houses
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=raw,value=latest,enable=${{ github.ref == 'refs/heads/master' }}
          type=sha,prefix={{date 'YYYYMMDD'}}-
          
    - name: Construir y subir imagen FastAPI
      uses: docker/build-push-action@v5
      with:
        context: ./proyecto-04/02_Segunda_maquina/api/fastapi
        file: ./proyecto-04/02_Segunda_maquina/api/fastapi/Dockerfile
        push: true
        tags: ${{ steps.meta-fastapi.outputs.tags }}
        labels: ${{ steps.meta-fastapi.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha,scope=fastapi
        cache-to: type=gha,mode=max,scope=fastapi
        
    - name: Extraer tag de despliegue
      id: extract-tag
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
          echo "tag=$(date '+%Y%m%d')-${{ github.sha }}" >> $GITHUB_OUTPUT
        else
          echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        fi
        
    - name: Resumen imagen FastAPI
      run: |
        echo "‚úÖ ¬°Imagen FastAPI construida y subida exitosamente!"
        echo "üì¶ Imagen: ${{ secrets.DOCKER_USERNAME }}/fastapi-houses"
        echo "üè∑Ô∏è  Tags: ${{ steps.meta-fastapi.outputs.tags }}"
        echo "üéØ Tag de despliegue: ${{ steps.extract-tag.outputs.tag }}"

  build-gradio:
    name: Construir Imagen Gradio
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.extract-tag.outputs.tag }}
    
    steps:
    - name: Descargar c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Iniciar sesi√≥n en Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Extraer metadatos de Gradio
      id: meta-gradio
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKER_USERNAME }}/gradio-houses
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=raw,value=latest,enable=${{ github.ref == 'refs/heads/master' }}
          type=sha,prefix={{date 'YYYYMMDD'}}-
          
    - name: Construir y subir imagen Gradio
      uses: docker/build-push-action@v5
      with:
        context: ./proyecto-04/02_Segunda_maquina/api/gradio
        file: ./proyecto-04/02_Segunda_maquina/api/gradio/Dockerfile
        push: true
        tags: ${{ steps.meta-gradio.outputs.tags }}
        labels: ${{ steps.meta-gradio.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha,scope=gradio
        cache-to: type=gha,mode=max,scope=gradio
        
    - name: Extraer tag de despliegue
      id: extract-tag
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
          echo "tag=$(date '+%Y%m%d')-${{ github.sha }}" >> $GITHUB_OUTPUT
        else
          echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        fi
        
    - name: Resumen imagen Gradio
      run: |
        echo "‚úÖ ¬°Imagen Gradio construida y subida exitosamente!"
        echo "üì¶ Imagen: ${{ secrets.DOCKER_USERNAME }}/gradio-houses"
        echo "üè∑Ô∏è  Tags: ${{ steps.meta-gradio.outputs.tags }}"
        echo "üéØ Tag de despliegue: ${{ steps.extract-tag.outputs.tag }}"

  actualizar-manifiestos:
    name: Actualizar Manifiestos de Kubernetes
    runs-on: ubuntu-latest
    needs: [build-airflow, build-mlflow, build-fastapi, build-gradio]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    
    steps:
    - name: Descargar c√≥digo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Configurar Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
    - name: Actualizar tags de im√°genes en manifiestos
      run: |
        # Usar los tags que generaron los builds
        AIRFLOW_TAG="${{ needs.build-airflow.outputs.image-tag }}"
        MLFLOW_TAG="${{ needs.build-mlflow.outputs.image-tag }}"
        FASTAPI_TAG="${{ needs.build-fastapi.outputs.image-tag }}"
        GRADIO_TAG="${{ needs.build-gradio.outputs.image-tag }}"
        
        echo "üîÑ Actualizando manifiestos con tags:"
        echo "  Airflow: $AIRFLOW_TAG"
        echo "  MLflow: $MLFLOW_TAG"
        echo "  FastAPI: $FASTAPI_TAG"
        echo "  Gradio: $GRADIO_TAG"
        
        # Funci√≥n para actualizar archivos YAML
        actualizar_archivos_yaml() {
          local archivo=$1
          local nombre_imagen=$2
          local nuevo_tag=$3
          
          echo ""
          echo "üìÑ Procesando archivo: $archivo"
          echo "üñºÔ∏è  Imagen a buscar: $nombre_imagen"
          echo "üè∑Ô∏è  Nuevo tag: $nuevo_tag"
          
          if [[ -f "$archivo" ]]; then
            # Crear backup
            cp "$archivo" "$archivo.bak"
            
            # Buscar l√≠neas con la imagen antes del cambio
            echo "üîç L√≠neas actuales que coinciden:"
            grep -n "image:.*${nombre_imagen}" "$archivo" || echo "No se encontraron l√≠neas con la imagen"
            
            # Actualizar la imagen usando sed con una expresi√≥n m√°s espec√≠fica
            sed -i -E "s|(image:.*${nombre_imagen}):.*|\1:${nuevo_tag}|g" "$archivo"
            
            # Verificar si hubo cambios
            if ! cmp -s "$archivo" "$archivo.bak"; then
              echo "‚úÖ Actualizado: $archivo"
              echo "üéØ L√≠neas despu√©s del cambio:"
              grep -n "image:.*${nombre_imagen}" "$archivo" || echo "No se encontraron l√≠neas despu√©s del cambio"
              rm "$archivo.bak"
              return 0
            else
              echo "‚è≠Ô∏è  Sin cambios: $archivo"
              rm "$archivo.bak"
              return 1
            fi
          else
            echo "‚ùå Archivo no encontrado: $archivo"
            return 1
          fi
        }
        
        echo "üöÄ Iniciando actualizaci√≥n de manifiestos..."
        
        # Actualizar Airflow (aunque no se use en Argo CD, mantener actualizado)
        echo ""
        echo "üì¶ === ACTUALIZANDO AIRFLOW ==="
        if [[ -f "proyecto-04/01_Primera_maquina/airflow/manifests/airflow-deployment.yaml" ]]; then
          actualizar_archivos_yaml "proyecto-04/01_Primera_maquina/airflow/manifests/airflow-deployment.yaml" "${{ secrets.DOCKER_USERNAME }}/airflow-houses" "$AIRFLOW_TAG"
          AIRFLOW_UPDATED=$?
        elif [[ -f "proyecto-04/01_Primera_maquina/airflow/airflow-deployment.yaml" ]]; then
          actualizar_archivos_yaml "proyecto-04/01_Primera_maquina/airflow/airflow-deployment.yaml" "${{ secrets.DOCKER_USERNAME }}/airflow-houses" "$AIRFLOW_TAG"
          AIRFLOW_UPDATED=$?
        else
          echo "‚ÑπÔ∏è  No se encontr√≥ manifiesto de Airflow (se despliega con Docker Compose)"
          AIRFLOW_UPDATED=2
        fi
        
        # Actualizar MLflow
        echo ""
        echo "üì¶ === ACTUALIZANDO MLFLOW ==="
        actualizar_archivos_yaml "proyecto-04/01_Primera_maquina/mlflow/manifests/mlflow.yaml" "${{ secrets.DOCKER_USERNAME }}/mlflow-houses" "$MLFLOW_TAG"
        MLFLOW_UPDATED=$?
        
        # Actualizar FastAPI
        echo ""
        echo "üì¶ === ACTUALIZANDO FASTAPI ==="
        actualizar_archivos_yaml "proyecto-04/02_Segunda_maquina/api/fastapi/fastapi-deployment.yaml" "${{ secrets.DOCKER_USERNAME }}/fastapi-houses" "$FASTAPI_TAG"
        FASTAPI_UPDATED=$?
        
        # Actualizar Gradio
        echo ""
        echo "üì¶ === ACTUALIZANDO GRADIO ==="
        actualizar_archivos_yaml "proyecto-04/02_Segunda_maquina/api/gradio/gradio-deployment.yaml" "${{ secrets.DOCKER_USERNAME }}/gradio-houses" "$GRADIO_TAG"
        GRADIO_UPDATED=$?
        
        echo ""
        echo "üìã Resumen de actualizaciones:"
        [[ $AIRFLOW_UPDATED -eq 0 ]] && echo "‚úÖ Airflow actualizado" || [[ $AIRFLOW_UPDATED -eq 2 ]] && echo "‚ÑπÔ∏è  Airflow: Sin manifiestos K8s" || echo "‚ùå Airflow no se actualiz√≥"
        [[ $MLFLOW_UPDATED -eq 0 ]] && echo "‚úÖ MLflow actualizado" || echo "‚ùå MLflow no se actualiz√≥"
        [[ $FASTAPI_UPDATED -eq 0 ]] && echo "‚úÖ FastAPI actualizado" || echo "‚ùå FastAPI no se actualiz√≥"
        [[ $GRADIO_UPDATED -eq 0 ]] && echo "‚úÖ Gradio actualizado" || echo "‚ùå Gradio no se actualiz√≥"
        
        echo ""
        echo "‚úÖ ¬°Proceso de actualizaci√≥n completado!"
        
    - name: Mostrar cambios
      run: |
        echo "üìä Estado de Git despu√©s de las actualizaciones:"
        git status --porcelain
        
        if [[ -n $(git status --porcelain) ]]; then
          echo ""
          echo "üìù Archivos modificados:"
          git diff --name-only
          echo ""
          echo "üîç Cambios detallados:"
          git diff --unified=3
        else
          echo "‚ÑπÔ∏è  No se modificaron archivos de manifiestos"
        fi
        
    - name: Confirmar y subir cambios
      run: |
        if [[ -n $(git status --porcelain) ]]; then
          echo "üíæ Confirmando cambios..."
          
          # Agregar solo los archivos que existen y han cambiado
          [[ -f "proyecto-04/01_Primera_maquina/airflow/manifests/airflow-deployment.yaml" ]] && git add "proyecto-04/01_Primera_maquina/airflow/manifests/airflow-deployment.yaml"
          [[ -f "proyecto-04/01_Primera_maquina/airflow/airflow-deployment.yaml" ]] && git add "proyecto-04/01_Primera_maquina/airflow/airflow-deployment.yaml"
          [[ -f "proyecto-04/01_Primera_maquina/mlflow/manifests/mlflow.yaml" ]] && git add "proyecto-04/01_Primera_maquina/mlflow/manifests/mlflow.yaml"
          [[ -f "proyecto-04/02_Segunda_maquina/api/fastapi/fastapi-deployment.yaml" ]] && git add "proyecto-04/02_Segunda_maquina/api/fastapi/fastapi-deployment.yaml"  
          [[ -f "proyecto-04/02_Segunda_maquina/api/gradio/gradio-deployment.yaml" ]] && git add "proyecto-04/02_Segunda_maquina/api/gradio/gradio-deployment.yaml"
          
          # Crear mensaje de commit usando cat heredoc para evitar problemas de YAML
          git commit -m "$(cat << 'EOF'
ü§ñ Auto-actualizaci√≥n tags de im√°genes

üèóÔ∏è Build: ${{ github.sha }}
üåü Im√°genes actualizadas:
‚Ä¢ ${{ secrets.DOCKER_USERNAME }}/airflow-houses:${{ needs.build-airflow.outputs.image-tag }}
‚Ä¢ ${{ secrets.DOCKER_USERNAME }}/mlflow-houses:${{ needs.build-mlflow.outputs.image-tag }}
‚Ä¢ ${{ secrets.DOCKER_USERNAME }}/fastapi-houses:${{ needs.build-fastapi.outputs.image-tag }}
‚Ä¢ ${{ secrets.DOCKER_USERNAME }}/gradio-houses:${{ needs.build-gradio.outputs.image-tag }}

üìÇ Archivos actualizados autom√°ticamente:
‚Ä¢ proyecto-04/01_Primera_maquina/mlflow/manifests/mlflow.yaml
‚Ä¢ proyecto-04/02_Segunda_maquina/api/fastapi/fastapi-deployment.yaml
‚Ä¢ proyecto-04/02_Segunda_maquina/api/gradio/gradio-deployment.yaml

‚ÑπÔ∏è  Nota: Airflow se despliega independientemente con Docker Compose
EOF
)"
          
          echo "üöÄ Subiendo cambios..."
          git push
          echo "‚úÖ ¬°Cambios subidos exitosamente!"
        else
          echo "‚ÑπÔ∏è  No hay cambios para confirmar"
        fi
        
    - name: Informaci√≥n de Argo CD
      run: |
        echo "üéØ ¬°Manifiestos actualizados exitosamente!"
        echo ""
        echo "üìã Aplicaciones de Argo CD que se sincronizar√°n:"
        echo "‚Ä¢ mlflow-app (proyecto-04/01_Primera_maquina/mlflow/manifests)"
        echo "‚Ä¢ fastapi-app (proyecto-04/02_Segunda_maquina/api/fastapi)"
        echo "‚Ä¢ gradio-app (proyecto-04/02_Segunda_maquina/api/gradio)"
        echo ""
        echo "‚ÑπÔ∏è  Airflow: Se construye autom√°ticamente pero se despliega manualmente con Docker Compose"
        echo ""
        echo "‚è∞ Argo CD detectar√° los cambios en ~3 minutos (intervalo de sincronizaci√≥n por defecto)"
        echo "üîÑ O puedes sincronizar manualmente desde la UI de Argo CD"
        echo "üåê UI de Argo CD: https://localhost:30443"

  resumen-despliegue:
    name: Resumen del Despliegue
    runs-on: ubuntu-latest
    needs: [build-airflow, build-mlflow, build-fastapi, build-gradio, actualizar-manifiestos]
    if: always()
    
    steps:
    - name: Estado del despliegue
      run: |
        echo "üöÄ Resumen de Ejecuci√≥n del Pipeline MLOps"
        echo "=================================================="
        echo ""
        echo "üìä Resultados de Build:"
        echo "‚Ä¢ Build Airflow:          ${{ needs.build-airflow.result }}"
        echo "‚Ä¢ Build MLflow:           ${{ needs.build-mlflow.result }}"
        echo "‚Ä¢ Build FastAPI:          ${{ needs.build-fastapi.result }}"
        echo "‚Ä¢ Build Gradio:           ${{ needs.build-gradio.result }}"
        echo "‚Ä¢ Actualizar Manifiestos: ${{ needs.actualizar-manifiestos.result }}"
        echo ""
        echo "üåø Rama: ${{ github.ref_name }}"
        echo "üìù Commit: ${{ github.sha }}"
        echo ""
        
        if [[ "${{ needs.build-airflow.result }}" == "success" && "${{ needs.build-mlflow.result }}" == "success" && "${{ needs.build-fastapi.result }}" == "success" && "${{ needs.build-gradio.result }}" == "success" ]]; then
          echo "‚úÖ ¬°Todas las im√°genes construidas exitosamente!"
          echo ""
          echo "üì¶ Im√°genes disponibles en Docker Hub:"
          echo "‚Ä¢ ${{ secrets.DOCKER_USERNAME }}/airflow-houses:${{ needs.build-airflow.outputs.image-tag }}"
          echo "‚Ä¢ ${{ secrets.DOCKER_USERNAME }}/mlflow-houses:${{ needs.build-mlflow.outputs.image-tag }}"
          echo "‚Ä¢ ${{ secrets.DOCKER_USERNAME }}/fastapi-houses:${{ needs.build-fastapi.outputs.image-tag }}"
          echo "‚Ä¢ ${{ secrets.DOCKER_USERNAME }}/gradio-houses:${{ needs.build-gradio.outputs.image-tag }}"
          
          if [[ "${{ github.ref_name }}" == "master" ]]; then
            echo ""
            echo "üéØ Despliegue en Producci√≥n (rama master):"
            if [[ "${{ needs.actualizar-manifiestos.result }}" == "success" ]]; then
              echo "‚úÖ Manifiestos de Kubernetes actualizados autom√°ticamente"
              echo "üîÑ Argo CD sincronizar√° las nuevas im√°genes en ~3 minutos"
              echo "üåê Monitorear despliegue: https://localhost:30443"
            elif [[ "${{ needs.actualizar-manifiestos.result }}" == "skipped" ]]; then
              echo "‚è≠Ô∏è  Actualizaci√≥n de manifiestos omitida (no es push a master)"
            else
              echo "‚ùå Actualizaci√≥n de manifiestos fall√≥ - intervenci√≥n manual necesaria"
            fi
            echo ""
            echo "üìã Comandos de despliegue manual (si es necesario):"
            echo "# Kubernetes (v√≠a Argo CD o manualmente):"
            echo "sudo microk8s kubectl set image deployment/mlflow mlflow=${{ secrets.DOCKER_USERNAME }}/mlflow-houses:${{ needs.build-mlflow.outputs.image-tag }} -n mlops-project"
            echo "sudo microk8s kubectl set image deployment/fastapi-housing fastapi-housing=${{ secrets.DOCKER_USERNAME }}/fastapi-houses:${{ needs.build-fastapi.outputs.image-tag }} -n mlops-project"
            echo "sudo microk8s kubectl set image deployment/gradio-housing gradio-housing=${{ secrets.DOCKER_USERNAME }}/gradio-houses:${{ needs.build-gradio.outputs.image-tag }} -n mlops-project"
            echo ""
            echo "# Airflow (Docker Compose):"
            echo "cd proyecto-04/01_Primera_maquina/airflow && docker-compose pull && docker-compose up -d"
          else
            echo ""
            echo "üß™ Rama de Desarrollo (${{ github.ref_name }}):"
            echo "‚Ä¢ Im√°genes disponibles para pruebas"
            echo "‚Ä¢ Sin despliegue autom√°tico en producci√≥n"
            echo "‚Ä¢ Hacer merge a master para despliegue autom√°tico"
          fi
        else
          echo "‚ùå ¬°Algunos builds fallaron!"
          echo ""
          echo "üîç Componentes fallidos:"
          [[ "${{ needs.build-airflow.result }}" != "success" ]] && echo "‚Ä¢ Airflow: ${{ needs.build-airflow.result }}"
          [[ "${{ needs.build-mlflow.result }}" != "success" ]] && echo "‚Ä¢ MLflow: ${{ needs.build-mlflow.result }}"
          [[ "${{ needs.build-fastapi.result }}" != "success" ]] && echo "‚Ä¢ FastAPI: ${{ needs.build-fastapi.result }}"
          [[ "${{ needs.build-gradio.result }}" != "success" ]] && echo "‚Ä¢ Gradio: ${{ needs.build-gradio.result }}"
          [[ "${{ needs.actualizar-manifiestos.result }}" == "failure" ]] && echo "‚Ä¢ Actualizaci√≥n de Manifiestos: ${{ needs.actualizar-manifiestos.result }}"
          echo ""
          echo "üìñ Revisar los logs arriba para m√°s detalles"
          exit 1
        fi